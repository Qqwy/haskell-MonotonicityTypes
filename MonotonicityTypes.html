<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2019-06-09 zo 13:26 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>&lrm;</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Wiebe-Marten Wijnja" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgd8d42b8">1. Introduction</a></li>
<li><a href="#orgc9ccd6a">2. Preamble</a></li>
<li><a href="#orga7eea28">3. Building Sfuns as types that change under composition</a></li>
<li><a href="#orgb5623d9">4. Handling multi-parameter functions</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgd8d42b8" class="outline-2">
<h2 id="orgd8d42b8"><span class="section-number-2">1</span> Introduction</h2>
<div class="outline-text-2" id="text-1">
<p>
Dear Kevin Clancy, Heather Miller and Christopher Meiklejohn.
</p>

<p>
I very much enjoyed reading your whitepaper titled <b>Monotonicity Types</b>.
While reading I more and more got the suspicion that it might be possible to implement the essence of Monotonicity Types today in Haskell,
foregoing the need to build a completely separate language and compiler to annotate functions as monotonic, antitonic or neither.
</p>

<p>
This turned out to be a bit of a challenge, and I learned a lot about the dependently typed features that Haskell (provided you enable some GHC extensions) offers.
I believe the end result to be usable/practical today.
</p>

<p>
In this literate haskell document, I'll explain the implementation details.
As literate haskell, this org-mode document can be read both as LaTeX-PDF as well as Haskell source code.
</p>
</div>
</div>


<div id="outline-container-orgc9ccd6a" class="outline-2">
<h2 id="orgc9ccd6a"><span class="section-number-2">2</span> Preamble</h2>
<div class="outline-text-2" id="text-2">
<p>
As you can see, we require quite a few extensions. Why we need them will be explained when we require them.
</p>
<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #bc6ec5;">{-# LANGUAGE DataKinds  #-}</span>
<span style="color: #bc6ec5;">{-# LANGUAGE KindSignatures  #-}</span>
<span style="color: #bc6ec5;">{-# LANGUAGE TypeFamilies  #-}</span>
<span style="color: #bc6ec5;">{-# LANGUAGE PolyKinds  #-}</span>
<span style="color: #bc6ec5;">{-# LANGUAGE GADTs  #-}</span>

</pre>
</div>

<p>
Now for the head of the module:
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #4f97d7; font-weight: bold;">module</span> <span style="color: #ce537a; font-weight: bold;">MonotonicityTypes</span> <span style="color: #4f97d7; font-weight: bold;">where</span>

<span style="color: #4f97d7; font-weight: bold;">import</span> <span style="color: #4f97d7; font-weight: bold;">qualified</span> <span style="color: #ce537a; font-weight: bold;">Prelude</span>
<span style="color: #4f97d7; font-weight: bold;">import</span> <span style="color: #ce537a; font-weight: bold;">Prelude</span> <span style="color: #4f97d7; font-weight: bold;">hiding</span> <span style="color: #4f97d7;">(</span>id, <span style="color: #bc6ec5;">(</span><span style="color: #7590db;">.</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">import</span> <span style="color: #4f97d7; font-weight: bold;">qualified</span> <span style="color: #ce537a; font-weight: bold;">Control.Category</span>
<span style="color: #4f97d7; font-weight: bold;">import</span> <span style="color: #4f97d7; font-weight: bold;">qualified</span> <span style="color: #ce537a; font-weight: bold;">Control.Arrow</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orga7eea28" class="outline-2">
<h2 id="orga7eea28"><span class="section-number-2">3</span> Building Sfuns as types that change under composition</h2>
<div class="outline-text-2" id="text-3">
<p>
Let us start by defining a datatype for the different tonicity qualifiers that we want to support.
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #2aa1ae;">{-| Tonicity Qualifiers from section 4.2 of the paper.-}</span>
<span style="color: #4f97d7; font-weight: bold;">data</span> <span style="color: #ce537a; font-weight: bold;">TonicityQualifier</span> <span style="color: #7590db;">=</span> <span style="color: #ce537a; font-weight: bold;">Constant</span> <span style="color: #7590db;">|</span> <span style="color: #ce537a; font-weight: bold;">Monotone</span> <span style="color: #7590db;">|</span> <span style="color: #ce537a; font-weight: bold;">Antitone</span> <span style="color: #7590db;">|</span> <span style="color: #ce537a; font-weight: bold;">Unknown</span> <span style="color: #7590db;">|</span> <span style="color: #ce537a; font-weight: bold;">Discarded</span>
</pre>
</div>

<p>
But rather than using these as values, we will use them at the type level, restricting the type of <b>Sfuns</b>:
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #4f97d7; font-weight: bold;">newtype</span> <span style="color: #ce537a; font-weight: bold;">Sfun</span> <span style="color: #4f97d7;">(</span>t <span style="color: #7590db;">::</span> <span style="color: #ce537a; font-weight: bold;">TonicityQualifier</span><span style="color: #4f97d7;">)</span> input output <span style="color: #7590db;">=</span> <span style="color: #ce537a; font-weight: bold;">UnsafeMakeSfun</span> <span style="color: #4f97d7;">{</span> applySfun <span style="color: #7590db;">::</span> input <span style="color: #7590db;">-&gt;</span> output <span style="color: #4f97d7;">}</span>
</pre>
</div>

<p>
Besides being restricted by `t`, Sfuns are normal functions.
By declaring `UnsafeMakeSfun` as 'unsafe', people are discouraged from using it (but can still do so if they really know what they are doing).
We use it to tag the primitive functions that we know are monotone as such:
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">A few examples:</span>
<span style="color: #bc6ec5; font-weight: bold;">incrementSfun</span> <span style="color: #7590db;">::</span> <span style="color: #ce537a; font-weight: bold;">Num</span> a <span style="color: #7590db;">=&gt;</span> <span style="color: #ce537a; font-weight: bold;">Sfun</span> '<span style="color: #ce537a; font-weight: bold;">Monotone</span> a a
<span style="color: #bc6ec5; font-weight: bold;">incrementSfun</span> <span style="color: #7590db;">=</span> <span style="color: #ce537a; font-weight: bold;">UnsafeMakeSfun</span> <span style="color: #4f97d7;">(</span><span style="color: #7590db;">+</span> <span style="color: #a45bad;">1</span><span style="color: #4f97d7;">)</span>

<span style="color: #bc6ec5; font-weight: bold;">negateSfun</span> <span style="color: #7590db;">::</span> <span style="color: #ce537a; font-weight: bold;">Num</span> a <span style="color: #7590db;">=&gt;</span> <span style="color: #ce537a; font-weight: bold;">Sfun</span> '<span style="color: #ce537a; font-weight: bold;">Antitone</span> a a
<span style="color: #bc6ec5; font-weight: bold;">negateSfun</span> <span style="color: #7590db;">=</span> <span style="color: #ce537a; font-weight: bold;">UnsafeMakeSfun</span> <span style="color: #4f97d7;">(</span><span style="color: #7590db;">*</span> <span style="color: #bc6ec5;">(</span><span style="color: #7590db;">-</span><span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

</pre>
</div>

<p>
Normally, people will instead compose Sfuns together, which will result in an Sfun type that is their composition, as per figure 6 in the paper:
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">The composition of two Sfuns is the composition of their two functions,</span>
<span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">but with the type restricted to the composition of their tonicity qualifiers.</span>
<span style="color: #bc6ec5; font-weight: bold;">composeSfuns</span> <span style="color: #7590db;">::</span> <span style="color: #ce537a; font-weight: bold;">Sfun</span> t1 b c <span style="color: #7590db;">-&gt;</span> <span style="color: #ce537a; font-weight: bold;">Sfun</span> t2 a b <span style="color: #7590db;">-&gt;</span> <span style="color: #ce537a; font-weight: bold;">Sfun</span> <span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">ComposeTonicity</span> t1 t2<span style="color: #4f97d7;">)</span> a c
<span style="color: #bc6ec5; font-weight: bold;">composeSfuns</span> <span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">UnsafeMakeSfun</span> f<span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">UnsafeMakeSfun</span> g<span style="color: #4f97d7;">)</span> <span style="color: #7590db;">=</span> <span style="color: #ce537a; font-weight: bold;">UnsafeMakeSfun</span> <span style="color: #4f97d7;">(</span>f <span style="color: #7590db;">Prelude..</span> g<span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7; font-weight: bold;">type</span> <span style="color: #4f97d7; font-weight: bold;">family</span> <span style="color: #ce537a; font-weight: bold;">ComposeTonicity</span> <span style="color: #4f97d7;">(</span>t1 <span style="color: #7590db;">::</span> <span style="color: #ce537a; font-weight: bold;">TonicityQualifier</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">(</span>t2 <span style="color: #7590db;">::</span> <span style="color: #ce537a; font-weight: bold;">TonicityQualifier</span><span style="color: #4f97d7;">)</span>  <span style="color: #7590db;">::</span> <span style="color: #ce537a; font-weight: bold;">TonicityQualifier</span> <span style="color: #4f97d7; font-weight: bold;">where</span>
  <span style="color: #ce537a; font-weight: bold;">ComposeTonicity</span> '<span style="color: #ce537a; font-weight: bold;">Monotone</span> '<span style="color: #ce537a; font-weight: bold;">Monotone</span> <span style="color: #7590db;">=</span> '<span style="color: #ce537a; font-weight: bold;">Monotone</span>
  <span style="color: #ce537a; font-weight: bold;">ComposeTonicity</span> '<span style="color: #ce537a; font-weight: bold;">Monotone</span> '<span style="color: #ce537a; font-weight: bold;">Antitone</span> <span style="color: #7590db;">=</span> '<span style="color: #ce537a; font-weight: bold;">Antitone</span>
  <span style="color: #ce537a; font-weight: bold;">ComposeTonicity</span> '<span style="color: #ce537a; font-weight: bold;">Antitone</span> '<span style="color: #ce537a; font-weight: bold;">Antitone</span> <span style="color: #7590db;">=</span> '<span style="color: #ce537a; font-weight: bold;">Monotone</span>
  <span style="color: #ce537a; font-weight: bold;">ComposeTonicity</span> '<span style="color: #ce537a; font-weight: bold;">Antitone</span> '<span style="color: #ce537a; font-weight: bold;">Monotone</span> <span style="color: #7590db;">=</span> '<span style="color: #ce537a; font-weight: bold;">Antitone</span>
  <span style="color: #ce537a; font-weight: bold;">ComposeTonicity</span> '<span style="color: #ce537a; font-weight: bold;">Constant</span> other <span style="color: #7590db;">=</span> other
  <span style="color: #ce537a; font-weight: bold;">ComposeTonicity</span> other '<span style="color: #ce537a; font-weight: bold;">Constant</span> <span style="color: #7590db;">=</span> other
  <span style="color: #ce537a; font-weight: bold;">ComposeTonicity</span> '<span style="color: #ce537a; font-weight: bold;">Discarded</span> <span style="color: #4f97d7; font-weight: bold;">_</span> <span style="color: #7590db;">=</span> '<span style="color: #ce537a; font-weight: bold;">Discarded</span>
  <span style="color: #ce537a; font-weight: bold;">ComposeTonicity</span> <span style="color: #4f97d7; font-weight: bold;">_</span> '<span style="color: #ce537a; font-weight: bold;">Discarded</span> <span style="color: #7590db;">=</span> '<span style="color: #ce537a; font-weight: bold;">Discarded</span>
  <span style="color: #ce537a; font-weight: bold;">ComposeTonicity</span> <span style="color: #4f97d7; font-weight: bold;">_</span> <span style="color: #4f97d7; font-weight: bold;">_</span> <span style="color: #7590db;">=</span> '<span style="color: #ce537a; font-weight: bold;">Unknown</span>

</pre>
</div>

<p>
Now that we have defined composition, we can compose our sfuns as follows:
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">result1 :: Num a =&gt; Sfun 'Monotone a a</span>
<span style="color: #bc6ec5; font-weight: bold;">result1</span> <span style="color: #7590db;">=</span> composeSfuns incrementSfun incrementSfun

<span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">result2 :: Num a =&gt; Sfun 'Antitone a a</span>
<span style="color: #bc6ec5; font-weight: bold;">result2</span> <span style="color: #7590db;">=</span> composeSfuns negateSfun incrementSfun

<span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">result3 :: Num a =&gt; Sfun 'Antitone a a</span>
<span style="color: #bc6ec5; font-weight: bold;">result3</span> <span style="color: #7590db;">=</span> composeSfuns incrementSfun negateSfun

<span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">result4 :: Num a =&gt; Sfun 'Monotone a a</span>
<span style="color: #bc6ec5; font-weight: bold;">result4</span> <span style="color: #7590db;">=</span> composeSfuns negateSfun negateSfun

</pre>
</div>

<p>
Those type signatures are inferred. If you were to try for instance to write
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #bc6ec5; font-weight: bold;">result4'</span> <span style="color: #7590db;">::</span> <span style="color: #ce537a; font-weight: bold;">Num</span> a <span style="color: #7590db;">=&gt;</span> <span style="color: #ce537a; font-weight: bold;">Sfun</span> '<span style="color: #ce537a; font-weight: bold;">Antitone</span> a a
<span style="color: #bc6ec5; font-weight: bold;">result4'</span> <span style="color: #7590db;">=</span> composeSfuns negateSfun negateSfun
</pre>
</div>

<p>
then GHC will complain with a nice error:
</p>

<div class="org-src-container">
<pre class="src src-text">&#8226; Couldn't match type &#8216;'Monotone&#8217; with &#8216;'Antitone&#8217;
  Expected type: Sfun 'Antitone a a
    Actual type: Sfun (ComposeTonicity 'Antitone 'Antitone) a a
&#8226; In the expression: composeSfuns negateSfun negateSfun
  In an equation for &#8216;result4&#8217;:
      result4 = composeSfuns negateSfun negateSfun
</pre>
</div>

<p>
The foundation is there. However, to make this somewhat usable, we need to make it as seamless to use Sfuns:
To the user of the library, the fact that these functions are 'special' should mostly be hidden!
</p>

<p>
It can be recognized that Sfuns are almost an instance of Arrow: The fact that the type might change under composition
is not something that the normal Arrow typeclass can cope with.
</p>

<p>
Instead, we implement an 'Indexed Category' and an 'Indexed Arrow', which explicity captures this notion of types being able to change under composition.
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #2aa1ae;">-- | Behaves to `Control.Category` but has an extra `index` kind parameter,</span>
<span style="color: #2aa1ae;">-- | whose type-value might change under composition.</span>
<span style="color: #4f97d7; font-weight: bold;">class</span> <span style="color: #ce537a; font-weight: bold;">IndexedCategory</span> <span style="color: #4f97d7;">(</span>ic <span style="color: #7590db;">::</span> index <span style="color: #7590db;">-&gt;</span> <span style="color: #7590db;">*</span> <span style="color: #7590db;">-&gt;</span> <span style="color: #7590db;">*</span> <span style="color: #7590db;">-&gt;</span> <span style="color: #7590db;">*</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7; font-weight: bold;">where</span>
  <span style="color: #4f97d7; font-weight: bold;">type</span> <span style="color: #ce537a; font-weight: bold;">ComposeIndexes</span> <span style="color: #4f97d7;">(</span>index1 <span style="color: #7590db;">::</span> index<span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">(</span>index2 <span style="color: #7590db;">::</span> index<span style="color: #4f97d7;">)</span> <span style="color: #7590db;">::</span> index <span style="color: #2aa1ae;">-- ^ The resulting type under composition</span>
  id <span style="color: #7590db;">::</span> ic <span style="color: #4f97d7;">(</span>index' <span style="color: #7590db;">::</span> index<span style="color: #4f97d7;">)</span> a a
  <span style="color: #4f97d7;">(</span><span style="color: #7590db;">.</span><span style="color: #4f97d7;">)</span> <span style="color: #7590db;">::</span> ic i1 b c <span style="color: #7590db;">-&gt;</span> ic i2 a b <span style="color: #7590db;">-&gt;</span> ic <span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">ComposeIndexes</span> i1 i2<span style="color: #4f97d7;">)</span> a c

<span style="color: #2aa1ae;">-- | Common composition function</span>
<span style="color: #4f97d7; font-weight: bold;">infixr</span> <span style="color: #a45bad;">1</span> <span style="color: #7590db;">&gt;&gt;&gt;</span>
<span style="color: #4f97d7;">(</span><span style="color: #bc6ec5; font-weight: bold;">&gt;&gt;&gt;</span><span style="color: #4f97d7;">)</span> <span style="color: #7590db;">::</span> <span style="color: #ce537a; font-weight: bold;">IndexedCategory</span> ic <span style="color: #7590db;">=&gt;</span> ic i1 a b <span style="color: #7590db;">-&gt;</span> ic i2 b c <span style="color: #7590db;">-&gt;</span> ic <span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">ComposeIndexes</span> i2 i1<span style="color: #4f97d7;">)</span> a c
a <span style="color: #bc6ec5; font-weight: bold;">&gt;&gt;&gt;</span> b <span style="color: #7590db;">=</span> b <span style="color: #7590db;">.</span> a

<span style="color: #4f97d7; font-weight: bold;">infixr</span> <span style="color: #a45bad;">1</span> <span style="color: #7590db;">&lt;&lt;&lt;</span>
<span style="color: #4f97d7;">(</span><span style="color: #bc6ec5; font-weight: bold;">&lt;&lt;&lt;</span><span style="color: #4f97d7;">)</span> <span style="color: #7590db;">::</span> <span style="color: #ce537a; font-weight: bold;">IndexedCategory</span> ic <span style="color: #7590db;">=&gt;</span> ic i1 b c <span style="color: #7590db;">-&gt;</span> ic i2 a b <span style="color: #7590db;">-&gt;</span> ic <span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">ComposeIndexes</span> i1 i2<span style="color: #4f97d7;">)</span> a c
<span style="color: #4f97d7;">(</span><span style="color: #bc6ec5; font-weight: bold;">&lt;&lt;&lt;</span><span style="color: #4f97d7;">)</span> <span style="color: #7590db;">=</span> flip <span style="color: #4f97d7;">(</span><span style="color: #7590db;">&gt;&gt;&gt;</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7; font-weight: bold;">class</span> <span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">IndexedCategory</span> ic<span style="color: #4f97d7;">)</span> <span style="color: #7590db;">=&gt;</span> <span style="color: #ce537a; font-weight: bold;">IndexedArrow</span> ic <span style="color: #4f97d7; font-weight: bold;">where</span>
  <span style="color: #4f97d7; font-weight: bold;">type</span> <span style="color: #ce537a; font-weight: bold;">DefaultIndex</span> ic <span style="color: #7590db;">::</span> index
  arr <span style="color: #7590db;">::</span> <span style="color: #4f97d7;">(</span>index <span style="color: #7590db;">~</span> <span style="color: #ce537a; font-weight: bold;">DefaultIndex</span> ic<span style="color: #4f97d7;">)</span> <span style="color: #7590db;">=&gt;</span> <span style="color: #4f97d7;">(</span>a <span style="color: #7590db;">-&gt;</span> b<span style="color: #4f97d7;">)</span> <span style="color: #7590db;">-&gt;</span> ic index a b
  first <span style="color: #7590db;">::</span> ic index b c <span style="color: #7590db;">-&gt;</span> ic index <span style="color: #4f97d7;">(</span>b, d<span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">(</span>c, d<span style="color: #4f97d7;">)</span>


</pre>
</div>

<p>
These IndexedCategory and IndexedArrow typeclasses can be seen as a more general variant of the normal Category/Arrow, 
since all normal categories/arrows can be lifted to their indexed variant by indexing them by a placeholder type like `()`.
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #2aa1ae;">-- | Wrapper to lift normal categories to 'indexed' categories.</span>
<span style="color: #2aa1ae;">-- | We use the singleton kind `()` as 'index'.</span>
<span style="color: #4f97d7; font-weight: bold;">newtype</span> <span style="color: #ce537a; font-weight: bold;">FreeIndexed</span> <span style="color: #4f97d7;">(</span>c <span style="color: #7590db;">::</span> <span style="color: #7590db;">*</span> <span style="color: #7590db;">-&gt;</span> <span style="color: #7590db;">*</span> <span style="color: #7590db;">-&gt;</span> <span style="color: #7590db;">*</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">(</span>single <span style="color: #7590db;">::</span> <span style="color: #bc6ec5; font-weight: bold;">()</span><span style="color: #4f97d7;">)</span> a b <span style="color: #7590db;">=</span> <span style="color: #ce537a; font-weight: bold;">FreeIndexed</span> <span style="color: #4f97d7;">{</span> getCategory <span style="color: #7590db;">::</span> c a b <span style="color: #4f97d7;">}</span>


<span style="color: #4f97d7; font-weight: bold;">instance</span> <span style="color: #ce537a; font-weight: bold;">Control.Category.Category</span> c <span style="color: #7590db;">=&gt;</span> <span style="color: #ce537a; font-weight: bold;">IndexedCategory</span> <span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FreeIndexed</span> c<span style="color: #4f97d7;">)</span> <span style="color: #4f97d7; font-weight: bold;">where</span>
  <span style="color: #4f97d7; font-weight: bold;">type</span> <span style="color: #ce537a; font-weight: bold;">ComposeIndexes</span> a b <span style="color: #7590db;">=</span> '<span style="color: #4f97d7; font-weight: bold;">()</span>
  id <span style="color: #7590db;">=</span> <span style="color: #ce537a; font-weight: bold;">FreeIndexed</span> Control.Category.id
  <span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FreeIndexed</span> a<span style="color: #4f97d7;">)</span> <span style="color: #7590db;">.</span> <span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FreeIndexed</span> b<span style="color: #4f97d7;">)</span> <span style="color: #7590db;">=</span> <span style="color: #ce537a; font-weight: bold;">FreeIndexed</span> <span style="color: #4f97d7;">(</span>a <span style="color: #7590db;">Control.Category..</span> b<span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7; font-weight: bold;">instance</span> <span style="color: #ce537a; font-weight: bold;">Control.Arrow.Arrow</span> c <span style="color: #7590db;">=&gt;</span> <span style="color: #ce537a; font-weight: bold;">IndexedArrow</span> <span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FreeIndexed</span> c<span style="color: #4f97d7;">)</span> <span style="color: #4f97d7; font-weight: bold;">where</span>
  <span style="color: #4f97d7; font-weight: bold;">type</span> <span style="color: #ce537a; font-weight: bold;">DefaultIndex</span> <span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FreeIndexed</span> c<span style="color: #4f97d7;">)</span> <span style="color: #7590db;">=</span> '<span style="color: #4f97d7; font-weight: bold;">()</span>
  arr fun <span style="color: #7590db;">=</span> <span style="color: #ce537a; font-weight: bold;">FreeIndexed</span> <span style="color: #4f97d7;">(</span>Control.Arrow.arr fun<span style="color: #4f97d7;">)</span>
  first <span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FreeIndexed</span> cat<span style="color: #4f97d7;">)</span> <span style="color: #7590db;">=</span> <span style="color: #ce537a; font-weight: bold;">FreeIndexed</span> <span style="color: #4f97d7;">(</span>Control.Arrow.first cat<span style="color: #4f97d7;">)</span>

</pre>
</div>
</div>
</div>

<div id="outline-container-orgb5623d9" class="outline-2">
<h2 id="orgb5623d9"><span class="section-number-2">4</span> Handling multi-parameter functions</h2>
<div class="outline-text-2" id="text-4">
<p>
We now can perform the composition of Sfuns. However, if we try to build an Sfun that takes more than one parameter,
Haskell will interpret this in its usual, curried, sense, seeing it as an Sfun that takes one parameter,
and returns a new (non-Sfun) function that takes the rest of the parameters.
</p>

<p>
This is not what we want, because we want the Sfun to be qualified by the tonicity qualifiers of all of its parameter types,
not only the first.
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Wiebe-Marten Wijnja</p>
<p class="date">Created: 2019-06-09 zo 13:26</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
